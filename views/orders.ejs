<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manufacturer Orders</title>
  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background-color: #f6f8fa;
      margin: 30px;
      color: #111827;
    }
    h1 {
      text-align: center;
      color: #06122d;
      font-weight: 600;
      margin-bottom: 25px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: #ffffff;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.08);
    }
    td, th {
      border-bottom: 1px solid #e5e7eb;
      padding: 10px 12px;
      text-align: center;
      font-size: 14px;
    }
    th {
      background-color: #06122d;
      color: white;
      font-weight: 500;
    }
    tr:hover {
      background-color: #f1f5ff;
    }
    .status-select {
      border: 1px solid #d1d5db;
      border-radius: 5px;
      padding: 5px 8px;
      background-color: #f9fafb;
      font-size: 14px;
    }
    .submit-btn {
      background-color: #06122d;
      color: white;
      border-radius: 6px;
      padding: 8px 14px;
      border: none;
      cursor: pointer;
    }
    .submit-btn:hover {
      background-color: #111827;
    }
    .delivered-status {
      color: green;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Manufacturer Orders</h1>

  <table>
    <thead>
      <tr>
        <th>Manufacturer Order No.</th>
        <th>Salesforce Order No.</th>
        <th>Dealer Name</th>
        <th>Vehicle</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      <% if (orders.length === 0) { %>
        <tr><td colspan="5">No Orders Found</td></tr>
      <% } else { %>
        <% orders.forEach((order, index) => { %>
          <tr>
            <td><%= order.manufacturerOrderNo %></td>
            <td><%= order.salesOrderNo %></td>
            <td><%= order.dealerName %></td>
            <td><%= order.vehicle.join(", ") %></td>
            <td>
              <% if (order.status === "Delivered") { %>
                <span class="delivered-status"><%= order.status %></span>
              <% } else { %>
                <select class="status-select" data-index="<%= index %>">
                  <option value="Acknowledged" <%= order.status === "Acknowledged" ? "selected" : "" %>>Acknowledged</option>
                  <option value="Allocated" <%= order.status === "Allocated" ? "selected" : "" %>>Allocated</option>
                  <option value="In Production" <%= order.status === "In Production" ? "selected" : "" %>>In Production</option>
                  <option value="In Paint" <%= order.status === "In Paint" ? "selected" : "" %>>In Paint</option>
                  <option value="In Voiced" <%= order.status === "In Voiced" ? "selected" : "" %>>In Voiced</option>
                  <option value="In Transit" <%= order.status === "In Transit" ? "selected" : "" %>>In Transit</option>
                  <option value="Delivered" <%= order.status === "Delivered" ? "selected" : "" %>>Delivered</option>
                </select>
              <% } %>
            </td>
          </tr>
        <% }) %>
      <% } %>
    </tbody>
  </table>

  <div style="text-align:center; margin-top:20px;">
    <button class="submit-btn" id="submitBtn">Submit Status</button>
  </div>

  <script>
    const orders = <%- JSON.stringify(orders) %>;

    document.getElementById('submitBtn').addEventListener('click', async () => {
      document.querySelectorAll('.status-select').forEach((select, i) => {
        if (orders[i]) orders[i].status = select.value;
      });

      console.log('üß† Sending updated orders:', orders);

      try {
        const response = await fetch('/submit-statuses', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ orders })
        });

        const text = await response.text();
        console.log('‚úÖ Response:', text);
        alert('Statuses submitted successfully!');
      } catch (err) {
        console.error('‚ùå Error submitting statuses:', err);
        alert('Failed to submit orders.');
      }
    });
  </script>
</body>
